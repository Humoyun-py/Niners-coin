<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Control | Niners.uz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/main.css">
    <script src="../../js/translations.js"></script>
    <link rel="icon" type="image/png" href="../../assets/logo.png">
</head>

<body class="dashboard-grid">
    <div id="sidebarContainer"></div>
    <main class="main-content">
        <h2>Coin Control (Tuzatish)</h2>
        <p style="color:var(--text-muted); margin-bottom:24px;">Xatolarni tuzatish uchun o'quvchilar balansini qo'lda
            o'zgartirish.</p>

        <div class="card">
            <div class="form-group">
                <label>O'quvchini qidirish</label>
                <input type="text" id="studentSearch" class="form-control" placeholder="Ism yoki username..."
                    oninput="searchStudents()">
            </div>
            <div id="searchResults" class="mobile-stack" style="margin-top:20px; max-height: 400px; overflow-y: auto;">
                <!-- Result list -->
            </div>
        </div>
    </main>

    <script src="../../js/api.js"></script>
    <script src="../../js/admin.js"></script>
    <script src="../../js/sidebar-loader.js"></script>
    <script>
        // Notification helper (non-blocking)
        function showNotification(message, type = 'info', timeout = 3500) {
            let container = document.getElementById('notifyContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notifyContainer';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.right = '20px';
                container.style.zIndex = 99999;
                document.body.appendChild(container);
            }
            const el = document.createElement('div');
            el.className = 'notify ' + type;
            el.style.background = type === 'error' ? '#ffdddd' : (type === 'success' ? '#ddffdd' : '#ffffff');
            el.style.border = '1px solid #ddd';
            el.style.padding = '10px 14px';
            el.style.marginTop = '8px';
            el.style.borderRadius = '6px';
            el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.08)';
            el.style.fontSize = '0.95rem';
            el.style.color = '#222';
            el.innerText = message;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; el.style.transition = 'opacity 300ms'; setTimeout(()=>el.remove(), 300); }, timeout);
        }

        let allStudents = [];

        async function init() {
            const users = await api.get('/admin/users');
            allStudents = users.filter(u => u.role === 'student');
            renderStudents(allStudents);
        }

        function renderStudents(list) {
            const div = document.getElementById('searchResults');
            div.innerHTML = list.map(s => `
                <div style="padding:15px; border-bottom:1px solid #EEE; display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="font-weight:700;">${s.full_name}</div>
                        <div style="font-size:0.8rem; color:#666;">@${s.username} • Balance: ${s.debt_amount ? 'Blocked' : 'Active'}</div>
                    </div>
                    <button data-id="${s.id}" data-name="${encodeURIComponent(s.full_name)}" onclick="adjustCoinsPrompt(this.dataset.id, this.dataset.name)" class="btn btn-secondary">Sozlash</button>
                </div>
            `).join('');
        }

        function searchStudents() {
            const query = document.getElementById('studentSearch').value.toLowerCase();
            const results = allStudents.filter(s => s.full_name.toLowerCase().includes(query) || s.username.toLowerCase().includes(query));
            renderStudents(results);
        }

        function adjustCoinsPrompt(id, name) {
            // Normalize inputs
            const parsedId = parseInt(id, 10);
            const decodedName = typeof name === 'string' ? decodeURIComponent(name) : name;
            // Find student details from the loaded list
            const student = allStudents.find(s => s.id === parsedId) || {};
            const balance = student.coin_balance ?? 0;
            const is_active = ('is_active' in student) ? student.is_active : true;
            const block_reason = student.block_reason || '';
            const debt_amount = student.debt_amount ?? 0;

            // Create modal HTML
            const modalHTML = `
                <div class="modal-overlay active" id="coinModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                    <div class="modal-box" style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="modal-title" style="font-size: 1.25rem; font-weight: 700;">Coin Sozlash: ${decodedName}</div>
                            <button class="modal-close" onclick="document.getElementById('coinModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 12px; font-size:0.95rem; color:#333;">Hozirgi balans: <strong id="currentBalance">${balance}</strong></div>

                            <div class="input-group" style="margin-bottom: 16px;">
                                <label class="input-label" style="display: block; margin-bottom: 8px; font-weight: 600;">Coin Miqdori (Ayirish uchun minus, masalan -10)</label>
                                <input type="number" id="coinAmount" class="form-control" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                            </div>
                            <div class="input-group" style="margin-bottom: 16px;">
                                <label class="input-label" style="display: block; margin-bottom: 8px; font-weight: 600;">Sabab (Majburiy)</label>
                                <input type="text" id="coinReason" class="form-control" placeholder="Masalan: Uyga vazifa, jarima..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;">
                            </div>

                            <div style="margin-top: 12px; border-top:1px solid #eee; padding-top:12px;">
                                <div style="margin-bottom:8px;">Holat: <strong id="userStatus">${is_active ? 'Active' : 'Blocked'}</strong></div>
                                <div>
                                    ${is_active ? `
                                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                                        <input type="checkbox" id="confirmBlock" />
                                        <label for="confirmBlock">Bloklash uchun tasdiq</label>
                                    </div>
                                    <div id="blockInputs" style="display:none; margin-bottom:8px;">
                                        <input type="text" id="blockReason" class="form-control" placeholder="Sabab..." style="margin-bottom:8px; width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        <input type="number" id="blockDebt" class="form-control" placeholder="Qarz miqdori" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                    </div>
                                    <button class="btn btn-danger" id="blockBtn" style="margin-top:8px;">Bloklash</button>
                                    ` : `
                                    <div style="display:flex; gap:8px; align-items:center;">
                                        <div style="flex:1;">Sabab: <em>${block_reason}</em></div>
                                        <div style="flex:1; text-align:right;">Qarz: <strong>${debt_amount}</strong></div>
                                    </div>
                                    <button class="btn btn-success" id="unblockBtn" style="margin-top:8px;">Blokdan chiqarish</button>
                                    `}
                                </div>
                            </div>

                        </div>
                        <div style="margin-top: 16px; display: flex; justify-content: space-between; gap: 12px;">
                            <div style="flex:1; display:flex; gap:8px; align-items:center;">
                                <button class="btn btn-secondary" onclick="document.getElementById('coinModal').remove()" style="padding: 10px 20px; border-radius: 6px; cursor: pointer;">Bekor qilish</button>
                            </div>
                            <div style="flex:1; display:flex; justify-content:flex-end; gap: 12px;">
                                <button class="btn btn-primary" id="modalSaveBtn" style="padding: 10px 20px; border-radius: 6px; cursor: pointer; background: linear-gradient(135deg, #FFD700, #FFA500); border: none; color: #000; font-weight: 700;">Tasdiqlash</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Focus on first input
            setTimeout(() => document.getElementById('coinAmount').focus(), 100);

            // Toggle block inputs when checkbox clicked
            const confirmBlock = document.getElementById('confirmBlock');
            if (confirmBlock) {
                confirmBlock.onchange = () => {
                    document.getElementById('blockInputs').style.display = confirmBlock.checked ? 'block' : 'none';
                }
            }

            // Handle block
            const blockBtn = document.getElementById('blockBtn');
            if (blockBtn) {
                blockBtn.onclick = async () => {
                    const reason = document.getElementById('blockReason').value || 'Sabab ko\'rsatilmagan';
                    const debt = parseFloat(document.getElementById('blockDebt').value || 0);
                    blockBtn.disabled = true; blockBtn.innerText = 'Yuklanmoqda...';
                    try {
                        const res = await api.post(`/admin/users/${id}/toggle-block`, { reason: reason, debt: debt });
                        showNotification(res.msg, 'success');
                        document.getElementById('coinModal').remove();
                        location.reload();
                    } catch (e) {
                        showNotification('Xatolik: ' + (e.message || 'Noma\'lum'), 'error');
                        blockBtn.disabled = false; blockBtn.innerText = 'Bloklash';
                    }
                }
            }

            // Handle unblock
            const unblockBtn = document.getElementById('unblockBtn');
            if (unblockBtn) {
                unblockBtn.onclick = async () => {
                    unblockBtn.disabled = true; unblockBtn.innerText = 'Yuklanmoqda...';
                    try {
                        const res = await api.post(`/admin/users/${id}/toggle-block`, {});
                        showNotification(res.msg, 'success');
                        document.getElementById('coinModal').remove();
                        location.reload();
                    } catch (e) {
                        showNotification('Xatolik: ' + (e.message || 'Noma\'lum'), 'error');
                        unblockBtn.disabled = false; unblockBtn.innerText = 'Blokdan chiqarish';
                    }
                }
            }

            // Handle save (adjust coins)
            document.getElementById('modalSaveBtn').onclick = async () => {
                const amount = document.getElementById('coinAmount').value;
                const reason = document.getElementById('coinReason').value;

                if (!amount || !reason) {
                    showNotification("Iltimos, miqdor va sababni kiriting!", 'error');
                    return;
                }

                const btn = document.getElementById('modalSaveBtn');
                btn.innerHTML = 'Yuklanmoqda...';
                btn.disabled = true;

                try {
                    const res = await api.post(`/admin/users/${id}/adjust-coins`, {
                        amount: parseInt(amount),
                        reason: reason
                    });
                    showNotification(res.msg + (res.new_balance ? (" — Yangi balans: " + res.new_balance) : ''), 'success');
                    // Update balance in modal if still present
                    const cb = document.getElementById('currentBalance'); if (cb && res.new_balance) cb.innerText = res.new_balance;
                    setTimeout(() => { try { document.getElementById('coinModal').remove(); location.reload(); } catch(e){} }, 600);
                } catch (e) {
                    showNotification("Xatolik: " + (e.message || 'Noma\'lum xatolik'), 'error');
                    btn.innerHTML = 'Tasdiqlash';
                    btn.disabled = false;
                }
            };
        }

        init();
    </script>
</body>

</html>