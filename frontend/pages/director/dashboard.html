<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director Dashboard | Niners.uz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/main.css">
</head>

<body class="dashboard-grid">
    <div id="sidebarContainer"></div>
    <main class="main-content">
        <header style="margin-bottom: 30px;">
            <h2 data-i18n="director_title">Director Executive Dashboard</h2>
            <p style="color:var(--text-muted);" data-i18n="director_subtitle">Tizim ko'rsatkichlari va boshqaruv paneli.
            </p>
        </header>

        <style>
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 16px;
                margin-bottom: 24px;
            }

            .stat-card {
                padding: 16px;
                border: 1px solid var(--border-light);
                border-radius: 12px;
                background: white;
                display: flex;
                flex-direction: column;
                justify-content: center;
                box-shadow: var(--shadow-soft);
            }
        </style>

        <div class="stats-grid">
            <div class="stat-card">
                <p class="font-xs"
                    style="color: var(--text-muted); font-weight: 700; margin-bottom: 4px; font-size: 0.75rem;">UMUMIY
                    KOINLAR</p>
                <h3 id="totalCoins" style="font-size: 1.5rem; color: var(--text-dark);">0</h3>
            </div>
            <div class="stat-card">
                <p class="font-xs"
                    style="color: var(--text-muted); font-weight: 700; margin-bottom: 4px; font-size: 0.75rem;">
                    O'QUVCHILAR</p>
                <h3 id="totalStudents" style="font-size: 1.5rem; color: var(--text-dark);">0</h3>
            </div>
            <div class="stat-card">
                <p class="font-xs"
                    style="color: var(--text-muted); font-weight: 700; margin-bottom: 4px; font-size: 0.75rem;">USTOZLAR
                </p>
                <h3 id="totalTeachers" style="font-size: 1.5rem; color: var(--text-dark);">0</h3>
            </div>
            <div class="stat-card" style="border-left: 4px solid var(--primary);">
                <p class="font-xs"
                    style="color: var(--text-muted); font-weight: 700; margin-bottom: 4px; font-size: 0.75rem;">GURUHLAR
                </p>
                <h3 id="totalGroups" style="font-size: 1.5rem; color: var(--primary-alt);">0</h3>
            </div>
        </div>

        <section id="approvalRequests" style="margin-bottom: 40px;">
            <h3 style="margin-bottom: 20px;" data-i18n="pending_approvals">üõéÔ∏è Pending Approvals</h3>
            <div id="requestsList" style="display: grid; gap: 16px;">
                <p data-i18n="loading_data">Loading requests...</p>
            </div>
        </section>

        <section style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
            <div class="card">
                <h3 data-i18n="instructor_rankings">Instructor Rankings</h3>
                <div id="teacherRating" style="margin-top: 20px;">
                    <p style="color:var(--text-muted);">Loading ratings...</p>
                </div>
                <a href="teachers-rating.html" class="btn btn-secondary"
                    style="margin-top: 15px; width: 100%; justify-content: center;">Full Rating</a>
            </div>
            <div class="card" style="background: var(--primary-gradient); color: var(--text-dark);">
                <h3 data-i18n="school_policy">School Policy</h3>
                <div id="policyBrief" style="margin-top: 10px;">
                    <p style="font-weight: 600;">Daily Coin Limit: <span id="dailyLimitVal">--</span> üü°</p>
                </div>
                <a href="coin-policy.html" class="btn btn-secondary"
                    style="margin-top: 20px; border: none; width: 100%; justify-content: center;"
                    data-i18n="adjust_limit">Adjust Policy</a>
            </div>
        </section>

        <section style="margin-top: 32px;">
            <div class="card" style="background: #FFF9F9; border: 1px dashed #FFCDCD;">
                <h3 style="margin-bottom: 20px;" data-i18n="quick_management">Quick Management</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                    <a href="users.html" class="btn btn-secondary" style="justify-content: start;">üë• Student/Teacher
                        CRUD</a>
                    <a href="classes.html" class="btn btn-secondary" style="justify-content: start;">üè´ Group
                        Management</a>
                    <a href="coin-control.html" class="btn btn-secondary" style="justify-content: start;">üü° Coin
                        Adjustments</a>
                    <a href="appeals.html" class="btn btn-secondary" style="justify-content: start;">üì© Appeals &
                        Feedbacks</a>
                    <a href="shop-management.html" class="btn btn-secondary" style="justify-content: start;">üõçÔ∏è Shop
                        Control</a>
                    <a href="badges.html" class="btn btn-secondary" style="justify-content: start;">üèÜ Badge
                        Management</a>
                </div>
            </div>
        </section>
    </main>

    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <script src="../../js/translations.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/admin.js"></script>
    <script src="../../js/sidebar-loader.js"></script>
    <script>
        async function loadRequests() {
            try {
                const reqs = await api.get('/director/approval-requests');
                const list = document.getElementById('requestsList');
                if (!reqs || reqs.length === 0) {
                    list.innerHTML = `<div class="card" style="text-align:center; color:#999;">${t('no_pending_requests')}</div>`;
                    return;
                }
                list.innerHTML = reqs.map(r => `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <div style="font-weight:800; font-size:1.1rem;">${r.title}</div>
                            <div style="color:#666; font-size:0.9rem;">${r.description}</div>
                            <div style="font-size:0.75rem; color:#999; margin-top:5px;">Sent by: ${r.admin} | ${new Date(r.timestamp).toLocaleString()}</div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="actionRequest(${r.id}, 'approved')" class="btn btn-primary" style="background:#2E7D32; color:white;">${t('approve')}</button>
                            <button onclick="actionRequest(${r.id}, 'rejected')" class="btn btn-secondary" style="color:#C62828; border-color:#FFEBEE;">${t('reject')}</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function loadTeacherRatings() {
            try {
                const teachers = await api.get('/director/teachers-rating');
                const container = document.getElementById('teacherRating');
                if (!teachers || teachers.length === 0) {
                    container.innerHTML = '<p>No ratings available.</p>';
                    return;
                }
                const top3 = teachers.slice(0, 3);
                container.innerHTML = top3.map((t, idx) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-weight:800; color:var(--primary); width:20px;">#${idx + 1}</span>
                            <div>
                                <div style="font-weight:600; font-size:0.95rem;">${t.name}</div>
                                <div style="font-size:0.75rem; color:var(--text-muted);">${t.subject || 'Instructor'}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700; color:var(--text-dark);">${t.coins_given.toLocaleString()} üü°</div>
                            <div style="font-size:0.7rem; color:#F1C40F;">‚òÖ ${t.rating.toFixed(1)}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function loadPolicy() {
            try {
                const policy = await api.get('/director/policy');
                if (policy && policy.daily_limit) {
                    document.getElementById('dailyLimitVal').innerText = policy.daily_limit;
                }
            } catch (e) { console.error(e); }
        }

        async function actionRequest(id, status) {
            try {
                await api.post(`/director/approval-requests/${id}/action`, { status: status });
                alert(`So'rov ${status === 'approved' ? 'tasdiqlandi' : 'rad etildi'}`);
                loadRequests();
            } catch (e) { alert("Xatolik yuz berdi"); }
        }

        async function loadStats() {
            try {
                const data = await api.get('/director/analytics');
                if (data && data.stats) {
                    document.getElementById('totalCoins').innerText = data.stats.total_coins_awarded.toLocaleString();
                    document.getElementById('totalStudents').innerText = data.stats.total_active_students;
                    document.getElementById('totalTeachers').innerText = data.stats.total_teachers;
                    document.getElementById('totalGroups').innerText = data.stats.active_classes;
                }
            } catch (e) { console.error(e); }
        }

        async function init() {
            LanguageModule.init();
            await Promise.all([
                loadRequests(),
                loadTeacherRatings(),
                loadPolicy(),
                loadStats()
            ]);
        }
        init();
    </script>
</body>

</html>