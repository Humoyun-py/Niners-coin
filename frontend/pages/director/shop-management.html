<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Management | Niners.uz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/main.css">
    <script src="../../js/translations.js"></script>
    <link rel="icon" type="image/png" href="../../assets/logo.png">
</head>

<body class="dashboard-grid">
    <style>
        .item-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            gap: 15px;
            flex-wrap: wrap;
            /* Allow wrapping */
        }

        @media (max-width: 768px) {
            .item-card {
                align-items: flex-start;
                flex-direction: column;
            }

            .item-info {
                width: 100%;
                justify-content: flex-start;
            }

            .action-buttons {
                width: 100%;
                display: flex;
                justify-content: flex-end;
                margin-top: 10px;
            }
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .item-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: #f0f0f0;
        }
    </style>
    <div id="sidebarContainer"></div>
    <main class="main-content" style="width: 86%;">
        <header class="dashboard-header flex-wrap-mobile">
            <div class="header-left">
                <div>
                    <h2>üõçÔ∏è Shop Management</h2>
                    <p class="user-role-badge">Director Panel</p>
                </div>
            </div>
            <button onclick="AdminModule.addShopItem()" class="btn btn-primary">+ Add New Item</button>
        </header>

        <section style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 32px;">
            <div>
                <h3 style="margin-bottom: 20px;">Inventory Items</h3>
                <div id="inventoryContainer" class="mobile-stack">
                    <p class="text-muted">Loading items...</p>
                </div>
            </div>

            <div>
                <h3 style="margin-bottom: 20px;">Purchase History</h3>
                <div id="historyContainer" class="card" style="padding: 20px; font-size: 0.9rem;">
                    <p class="text-muted">Loading history...</p>
                </div>
            </div>
        </section>
    </main>

    <script src="../../js/api.js"></script>
    <script src="../../js/admin.js"></script>
    <script src="../../js/sidebar-loader.js"></script>
    <script>
        async function loadShopData() {
            try {
                const items = await api.get('/admin/shop/items');
                const history = await api.get('/admin/shop/history');

                const invContainer = document.getElementById('inventoryContainer');
                invContainer.innerHTML = items.map(i => {
                    // FRONTEND MAPPER for images if not present or broken
                    let imgSrc = i.image_url || '';

                    // Fallback map
                    const fallbackImages = {
                        'Backpack': '/assets/Group%2025.jpg',
                        'Pen': '/assets/Group%2013.jpg',
                        'Note': '/assets/Group%2014.jpg',
                        '10% diskount': '/assets/Group7.jpg',
                        '20% diskount': '/assets/Group8.jpg',
                        '50% diskount': '/assets/Group9.jpg',
                        '100% diskount': '/assets/Group10.jpg',
                        'CEO': '/assets/Group%2022.jpg',
                        'Termos': '/assets/Group%2025.jpg',
                        'Cap': '/assets/Group%2015.jpg',
                        'T-shirt': '/assets/Group%2012.jpg',

                        // Electronics
                        '17 pro max': '/assets/Group%201.jpg',
                        '16 pro max': '/assets/Group%202.jpg',
                        'redmi': '/assets/Group%204.jpg',
                        'Samsung S25 Ultra': '/assets/Group%203.jpg',
                        'tv': '/assets/Group%205.jpg',
                        'playstation': '/assets/Group%206.jpg',
                        // Books
                        'IELTS book': '/assets/Group%2021.jpg',
                        'ielts exam': '/assets/Group%2023.jpg',
                        'upper intermediate book': '/assets/Group%2018.jpg',
                        'intermediate book': '/assets/Group%2019.jpg',
                        'Pre intermediatre book': '/assets/Group%2021.jpg',
                        'elementary book': '/assets/Group%2017.jpg',
                        'beginner book': '/assets/Group%2016.jpg'
                    };

                    const items = [
                        { name: "Pen", price: 200.00, color: "üü°", stock: 20 },
                        { name: "Backpack", price: 120, color: "üü°", stock: 10 },
                        { name: "10% diskount", price: 50, color: "üü°", stock: 50 },
                        { name: "20% diskount", price: 90.00, color: "üü°", stock: 50 },
                        { name: "50% diskount", price: 150.00, color: "üü°", stock: 50 },
                        { name: "100% diskount", price: 250.00, color: "üü°", stock: 50 },
                        { name: "CEO", price: 50, color: "üü°", stock: 20 },
                        { name: "Termos", price: 150.00, color: "üü°", stock: 50 },
                        { name: "Cap", price: 500, color: "üü°", stock: 2 },
                        { name: "T-shirt", price: 25, color: "üü°", stock: -1 },
                        { name: "Note", price: 12, color: "üü°", stock: -1 },
                        { name: "IELTS book", price: 20, color: "üü°", stock: 10 },
                        { name: "upper intermediate book", price: 30, color: "üü°", stock: 15 },
                        { name: "intermediate book", price: 200, color: "üü°", stock: 5 },
                        { name: "Pre intermediatre book", price: 40, color: "üü°", stock: 20 },
                        { name: "elementary book", price: 45, color: "üü°", stock: 10 },
                        { name: "beginner book", price: 80, color: "üü°", stock: 30 },
                        { name: "ielts exam", price: 250, color: "üü°", stock: 8 },
                        { name: "17 pro max", price: 3200.00, color: "üü°", stock: 6 },
                        { name: "16 pro max", price: 3000.00, color: "üü°", stock: 3 },
                        { name: "redmi", price: 500.00, color: "üü°", stock: 10 },
                        { name: "tv", price: 1500.00, color: "üü°", stock: 5 },
                        { name: "playstation", price: 1500.00, color: "üü°", stock: 3 },
                        { name: "Samsung S25 Ultra", price: 3000.00, color: "üü°", stock: 3 },
                    ];
                    const shop = document.getElementById("shop");

                    items.forEach(item => {
                        const img = fallbackImages[item.name] || fallbackImages.default;

                        shop.innerHTML += `
        <div class="card">
            <img src="${img}">
            <h4>${item.name}</h4>
            <div class="price">${item.price} ü™ô</div>
            <button onclick="buy('${item.name}')">Sotib olish</button>
        </div>
    `;
                    });

                    function buy(name) {
                        alert(name + " demo xarid qilindi ‚úÖ");
                    }

                    if (!imgSrc || imgSrc === 'null') {
                        // Try to match by name (case insensitive partial match)
                        const lowerName = i.name.toLowerCase();
                        for (const key in fallbackImages) {
                            if (lowerName.includes(key)) {
                                imgSrc = fallbackImages[key];
                                break;
                            }
                        }
                    }

                    if (!imgSrc) {
                        imgSrc = 'https://via.placeholder.com/100x100?text=No+Image';
                    } else if (!imgSrc.startsWith('http') && !imgSrc.startsWith('data:')) {
                        if (imgSrc.startsWith('/')) imgSrc = imgSrc.substring(1);

                        if (imgSrc.startsWith('uploads/')) imgSrc = '/' + imgSrc;
                        else if (imgSrc.startsWith('shop/')) imgSrc = '/uploads/' + imgSrc;
                        else imgSrc = '/uploads/shop/' + imgSrc;
                    }
                    return `
                    <div class="item-card">
                        <div class="item-info">
                            <img src="${imgSrc}" 
                                 class="item-img" 
                                 alt="${i.name}"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/100x100/cccccc/666666?text=No+Image';"
                                 style="width: 100px; height: 100px; object-fit: cover; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div>
                                <h4 style="margin:0;">${i.name}</h4>
                                <div style="color:var(--primary); font-weight:700;">${parseFloat(i.price).toFixed(2)} üü°</div>
                                <div style="font-size:0.8rem; color:#888;">Stock: ${i.stock === -1 ? '‚àû' : i.stock}</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="AdminModule.editShopItem(${i.id})" class="btn btn-secondary" style="padding:6px 12px; font-size:0.8rem;">Edit</button>
                            <button onclick="AdminModule.deleteShopItem(${i.id})" class="btn" style="padding:6px 12px; font-size:0.8rem; background:#FFE0E0; color:#DC3545; border:none;">Delete</button>
                        </div>
                    </div>
                `}).join('') || '<p>No items in inventory.</p>';

                const histContainer = document.getElementById('historyContainer');
                histContainer.innerHTML = history.map(h => `
                    <div style="border-bottom:1px solid #eee; padding:10px 0;">
                        <div style="font-weight:600;">${h.student} bought ${h.item}</div>
                        <div style="font-size:0.75rem; color:#999;">${h.date} ‚Ä¢ ${parseFloat(h.price).toFixed(2)} üü°</div>
                    </div>
                `).join('') || '<p>No purchases yet.</p>';

            } catch (e) { console.error(e); }
        }

        // Custom reload for standalone page
        AdminModule.reloadShopItems = loadShopData;

        // Override the default alert-then-reload to use our internal reload
        const originalAdd = AdminModule.addShopItem;
        AdminModule.addShopItem = function () {
            AdminModule.createModal('Add Shop Item', `
                <div class="input-group"><label class="input-label">Product Name (Nomi)</label><input type="text" id="itemName" class="form-control"></div>
                <div class="input-group"><label class="input-label">Price (Coin)</label><input type="number" id="itemPrice" class="form-control"></div>
                <div class="input-group"><label class="input-label">Stock (-1 for infinite)</label><input type="number" id="itemStock" class="form-control" value="-1"></div>
                <div class="input-group"><label class="input-label">Product Photo (Maxsulot rasmi)</label><input type="file" id="itemImageFile" class="form-control" accept="image/*"></div>
            `, async () => {
                const name = document.getElementById('itemName').value;
                const price = document.getElementById('itemPrice').value;
                const stock = document.getElementById('itemStock').value;
                const imageFile = document.getElementById('itemImageFile').files[0];

                if (!name || !price) return alert("Name and Price required");

                let imageUrl = '';
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    try {
                        const uploadRes = await api.upload('/admin/upload-image', formData);
                        imageUrl = uploadRes.url;
                    } catch (e) {
                        return alert("Image upload failed: " + e.message);
                    }
                }

                try {
                    await api.post('/admin/shop/items', {
                        name,
                        price: parseFloat(price),
                        stock: parseInt(stock),
                        image_url: imageUrl
                    });
                    loadShopData();
                } catch (e) { alert("Error: " + e.message); }
            }, 'Add Product');
        };

        AdminModule.editShopItem = async (itemId) => {
            try {
                const items = await api.get('/admin/shop/items');
                const item = items.find(i => i.id === itemId);
                if (!item) return;

                AdminModule.createModal('Edit Shop Item', `
                    <div class="input-group"><label class="input-label">Product Name (Nomi)</label><input type="text" id="editItemName" class="form-control" value="${item.name}"></div>
                    <div class="input-group"><label class="input-label">Price (Coin)</label><input type="number" id="editItemPrice" class="form-control" value="${item.price}"></div>
                    <div class="input-group"><label class="input-label">Stock</label><input type="number" id="editItemStock" class="form-control" value="${item.stock}"></div>
                    <div class="input-group"><label class="input-label">Replace Photo (Optional)</label><input type="file" id="editItemImageFile" class="form-control" accept="image/*"></div>
                `, async () => {
                    const name = document.getElementById('editItemName').value;
                    const price = document.getElementById('editItemPrice').value;
                    const stock = document.getElementById('editItemStock').value;
                    const imageFile = document.getElementById('editItemImageFile').files[0];

                    let imageUrl = item.image_url;
                    if (imageFile) {
                        const formData = new FormData();
                        formData.append('image', imageFile);
                        const uploadRes = await api.upload('/admin/upload-image', formData);
                        imageUrl = uploadRes.url;
                    }

                    try {
                        await api.put(`/admin/shop/items/${itemId}`, {
                            name,
                            price: parseFloat(price),
                            stock: parseInt(stock),
                            image_url: imageUrl
                        });
                        loadShopData();
                    } catch (e) { alert("Error: " + e.message); }
                }, 'Update Product');
            } catch (e) { alert("Error: " + e.message); }
        };

        const originalDelete = AdminModule.deleteShopItem;
        AdminModule.deleteShopItem = async (id) => {
            if (!confirm("Delete this item?")) return;
            try {
                await api.delete(`/admin/shop/items/${id}`);
                loadShopData();
            } catch (e) { alert("Error: " + e.message); }
        };

        loadShopData();
    </script>
</body>

</html>