<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Group | Niners.uz</title>
    <link rel="icon" type="image/png" href="../../assets/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles/main.css">
</head>

<body class="dashboard-grid">
    <div id="sidebarContainer"></div>
    <main class="main-content">
        <header class="dashboard-header flex-wrap-mobile">
            <div class="header-left">
                <div>
                    <h2 id="classNameDisplay">Loading...</h2>
                    <p id="teacherNameDisplay" class="user-role-badge">Your Teacher: Loading...</p>
                </div>
            </div>
        </header>

        <div class="card"
            style="background: white; padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-soft);">
            <h3 style="margin-bottom: 20px;">Classmates</h3>
            <div id="classmatesList" class="mobile-stack"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
                <!-- Classmates will be loaded here -->
            </div>
        </div>

        <div id="groupTopics" style="margin-top: 32px;">
            <h3 style="margin-bottom: 20px;">Recent Topics</h3>
            <div id="topicsList">
                <!-- Topics will be loaded here -->
            </div>
        </div>
    </main>
    </div>

    <script src="/js/translations.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sidebar-loader.js"></script>
    <script>
        async function loadGroupData() {
            try {
                const data = await api.get('/student/my-class');
                document.getElementById('classNameDisplay').innerText = data.class_name;
                document.getElementById('teacherNameDisplay').innerText = `Teacher: ${data.teacher_name}`;

                const list = document.getElementById('classmatesList');

                // Sort by coin_balance
                const sortedClassmates = data.classmates.sort((a, b) => (b.coin_balance || 0) - (a.coin_balance || 0));

                list.innerHTML = sortedClassmates.map((c, index) => {
                    const rank = index + 1;
                    const rankColor = rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : rank === 3 ? '#CD7F32' : '#999';
                    const bgColor = rank <= 3 ? '#fff9e6' : '#F8F9FA';
                    const borderColor = rank <= 3 ? '#ffd700' : '#EEE';

                    return `
                    <div style="background: ${bgColor}; padding: 12px; border-radius: 12px; display: flex; align-items: center; gap: 10px; border: 2px solid ${borderColor}; width: 100%; box-sizing: border-box;">
                        <div style="font-size: 1.1rem; font-weight: 700; color: ${rankColor}; min-width: 24px;">
                            ${rank}
                        </div>
                        <div style="width: 36px; height: 36px; flex-shrink: 0; background: ${c.is_me ? 'var(--primary-gradient)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700;">
                            ${c.full_name[0]}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95rem;">${c.full_name} ${c.is_me ? '(You)' : ''}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">@${c.username || 'student'}</div>
                        </div>
                        <div style="font-weight: 700; color: #f59e0b; font-size: 1rem; white-space: nowrap;">
                            ${(c.coin_balance || 0).toFixed(1)} ðŸŸ¡
                        </div>
                    </div>
                `}).join('');

                // Load Topics as well
                const topics = await api.get('/student/my-group/topics');
                const tList = document.getElementById('topicsList');
                if (topics.length === 0) {
                    tList.innerHTML = '<p style="color: var(--text-muted);">No topics added yet.</p>';
                } else {
                    tList.innerHTML = topics.map(t => `
                        <div class="card" style="margin-bottom: 12px; padding: 16px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h4 style="margin: 0 0 4px 0;">${t.title}</h4>
                                    <p style="margin: 0; font-size: 0.9rem; color: #555;">${t.content}</p>
                                </div>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">${t.date}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error(e);
                if (e.message && e.message.includes("Siz guruhga biriktirilmagansiz")) {
                    document.querySelector('.main-content').innerHTML = `
                        <div style="text-align: center; padding: 50px 20px;">
                            <h2 style="color: var(--text-dark); margin-bottom: 10px;">Siz guruhga biriktirilmagansiz</h2>
                            <p style="color: var(--text-muted);">Iltimos, o'quv markazi ma'muriyatiga murojaat qiling.</p>
                        </div>
                    `;
                } else {
                    alert("Guruh ma'lumotlarini yuklashda xatolik yuz berdi.");
                }
            }
        }

        document.addEventListener('DOMContentLoaded', loadGroupData);
    </script>
</body>

</html>
